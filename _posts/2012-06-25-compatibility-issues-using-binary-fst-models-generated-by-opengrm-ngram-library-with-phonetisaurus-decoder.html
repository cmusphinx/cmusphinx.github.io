---
layout: post
status: publish
published: true
title: Compatibility issues using binary fst models generated by OpenGrm NGram Library
  with phonetisaurus decoder
author:
  display_name: John Salatas
  login: jsalatas
  email: jsalatas@gmail.com
  url: http://jsalatas.ictpro.gr
author_login: jsalatas
author_email: jsalatas@gmail.com
author_url: http://jsalatas.ictpro.gr
date: '2012-06-25 22:33:20 +0200'
date_gmt: '2012-06-25 19:33:20 +0200'
---
<p>(author: <a title="Personal blog" href="http://jsalatas.ictpro.gr" target="_blank">John Salatas</a>)</p>
<p><strong>Foreword</strong></p>
<p>Previous articles have shown how to use OpenGrm NGram Library for the encoding of joint multigram language models as WFST [1] and provided the code that simplifies and automates the fst model training [2]. As described in [1] the generated binary fst models with the procedures described in those articles are not directly usable from phonetisaurus [3] decoder.</p>
<p>This article will try to describe the compatibility issues in more details and provide some intuition on possible solutions and workarounds.</p>
<p><strong>1. Open issues</strong></p>
<p>Assuming a binary fst model, named cmudict.fst generated as described in [1], trying to evaluate it with phonetisaurus evaluate python script, results in the following error</p>
<p><span class="code"><code>$ ./evaluate.py --order 9 --modelfile cmudict.fst --testfile cmudict.dict.test.tabbed --prefix cmudict/cmudict<br />
../phonetisaurus-g2p --model=cmudict.fst --input=cmudict/cmudict.words --beam=1500 --alpha=0.6500 --prec=0.8500 --ratio=0.7200 --order=9 --words --isfile  > cmudict/cmudict.hyp<br />
Symbol: 'A' not found in input symbols table.<br />
Mapping to null...<br />
Symbol: '4' not found in input symbols table.<br />
Mapping to null...<br />
Symbol: '2' not found in input symbols table.<br />
Mapping to null...<br />
Symbol: '1' not found in input symbols table.<br />
Mapping to null...<br />
Symbol: '2' not found in input symbols table.<br />
Mapping to null...<br />
Symbol: '8' not found in input symbols table.<br />
Mapping to null...<br />
sh: line 1: 18788 Segmentation fault      ../phonetisaurus-g2p --model=cmudict.fst --input=cmudict/cmudict.words --beam=1500 --alpha=0.6500 --prec=0.8500 --ratio=0.7200 --order=9 --words --isfile > cmudict/cmudict.hyp<br />
Words: 0  Hyps: 0 Refs: 13328<br />
Traceback (most recent call last):<br />
File "./evaluate.py", line 124, in <module><br />
mbrdecode=args.mbrdecode, beam=args.beam, alpha=args.alpha, precision=args.precision, ratio=args.ratio, order=args.order<br />
File "./evaluate.py", line 83, in evaluate_testset<br />
PERcalculator.compute_PER_phonetisaurus( hypothesisfile, referencefile, verbose=verbose )<br />
File "calculateER.py", line 333, in compute_PER_phonetisaurus<br />
assert len(words)==len(hyps) and len(hyps)==len(refs)<br />
AssertionError</code></span></p>
<p><strong>2. Disussion on open issues</strong></p>
<p>In order to investigate the error above, a simple aligned corpus was created as below</p>
<p><span class="code"><code>a}a b}b<br />
a}a<br />
a}a c}c<br />
a}a b}b c}c<br />
a}a c}c<br />
b}b c}c</code></span></p>
<p>This simple corpus was used as input to both ngram and phonetisaurus model training procedures [1], [3] and the generated fst model (binary.fst) was visualized as follows</p>
<p><span class="code"><code>$ fstdraw binary.fst binary.dot<br />
$ dot -Tps binary.dot > binary.ps</code></span></p>
<p>the generated two postscript outputs, using phonetisaurus and ngram respectively, are shown in the following figures:</p>
<p>[caption id="attachment_454" align="aligncenter" width="517" caption="Figure 1: Visualization of the fst model generated by phonetisaurus"]<a href="http://jsalatas.ictpro.gr/wp-content/uploads/2012/06/phonetisaurus.png"><img class="wp-image-454 " src="http://jsalatas.ictpro.gr/wp-content/uploads/2012/06/phonetisaurus-1024x298.png" alt="Visualization of the fst model generated by phonetisaurus" width="517" height="150" /></a>[/caption]</p>
<p style="text-align: center">
<p>[caption id="attachment_459" align="aligncenter" width="517" caption="Figure 2: Visualization of the fst model generated by ngram"]<a href="http://jsalatas.ictpro.gr/wp-content/uploads/2012/06/ngram.png"><img class="wp-image-459 " src="http://jsalatas.ictpro.gr/wp-content/uploads/2012/06/ngram-1024x261.png" alt="Visualization of the fst model generated by ngram" width="517" height="132" /></a>[/caption]</p>
<p>By studying the two figures above the first obvious conclusion is that the model generated with ngram do not distinguish between graphemes (input label) and phonemes (output label), but it uses the joint multigram (eg &ldquo;a}a&rdquo;) as both input and output label.</p>
<p>Another obvious difference between the two models is the starting and final state(s). Phonetisaurus models have a fixed starting state with a single outgoing arc with labels <s>:<s> and no weight. Furthermore, in phonetisaurus model there exist only a single final state with </s>:</s> labels in all incoming arcs.</p>
<p><strong>3. Possible solutions and workarounds</strong></p>
<p>[1] already presents a workaround to bypass the compatibility issues described in the previous section. We can simply export the ngram generated binary fst model to an ARPA format with:</p>
<p><span class="code"><code>$ ngramprint --ARPA binary.fst > export.arpa</code></span></p>
<p>and the use phonetisaurus' arpa2fst convert utility to regenerate a new binary fst model compatible with phonetisaurus' decoder.</p>
<p><span class="code"><code>$ phonetisaurus-arpa2fst &ndash;input=export.arpa</code></span></p>
<p>Although this is a straightforward procedure, a  more elegant solution would be to iterate in all arcs and manually break apart the grapheme/phoneme joint multigram labels to input/output labels accordingly. A final step, if necessary, would be to add the start and single final state in the ngram generated fst model.</p>
<p><strong>4. Conclusion &ndash; Future work</strong></p>
<p>This article tried to provide some intuition on the compatibility issues between ngram and phonetisaurus models and also to possible solutions and workarounds. As explained in the previous section, there is already a straightforward procedure to overcome these issues (export to ARPA format and regenerate the binary model), but in any case it is worth to try the relabeling approach described also in the previous section.</p>
<p><strong>References</strong></p>
<p>[1] <a title="Using OpenGrm NGram Library for the encoding of joint multigram language models as WFST." href="https://cmusphinx.github.io/2012/06/using-opengrm-ngram-library-for-the-encoding-of-joint-multigram-language-models-as-wfst/">Using OpenGrm NGram Library for the encoding of joint multigram language models as WFST.</a></p>
<p>[2] <a title="Automating the creation of joint multigram language models as WFST." href="https://cmusphinx.github.io/2012/06/automating-the-creation-of-joint-multigram-language-models-as-wfst/">Automating the creation of joint multigram language models as WFST.</a></p>
<p>[3] <a title="Phonetisaurus: A WFST-driven Phoneticizer &ndash; Framework Review" href="https://cmusphinx.github.io/2012/05/phonetisaurus-a-wfst-driven-phoneticizer-%e2%80%93-framework-review/">Phonetisaurus: A WFST-driven Phoneticizer &ndash; Framework Review</a></p>
